<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¤‘êµ­ì–´ ê°„ì²´ â†’ ì›ì–´ë¯¼ ë°œìŒ (GitHub Pages)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1027,#0f172a 40%,#0b1027);color:var(--fg);} 
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:blur(6px);border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:24px;margin:0 0 8px} p{color:var(--muted);margin:0 0 16px}
    textarea{width:100%;min-height:180px;padding:12px 14px;border-radius:12px;background:#0b1224;border:1px solid rgba(148,163,184,.25);color:var(--fg);resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    label{font-size:14px;color:var(--muted)} select,input[type="range"]{appearance:none;background:#0b1224;border:1px solid rgba(148,163,184,.25);color:var(--fg);border-radius:10px;padding:8px}
    button{border:0;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#022c3a;font-weight:700;cursor:pointer}
    button.sec{background:#0b1224;border:1px solid rgba(148,163,184,.25);color:var(--fg)}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.grid{grid-template-columns:2fr 1fr}}
    .list{font-size:14px;line-height:1.5;background:#0b1224;border:1px dashed rgba(148,163,184,.25);padding:12px;border-radius:12px;max-height:240px;overflow:auto}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.25);margin-right:6px}
    .foot{margin-top:14px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ì¤‘êµ­ì–´ ê°„ì²´ â†’ ì›ì–´ë¯¼ ë°œìŒ (ë¸Œë¼ìš°ì € ë‚´ì¥ TTS)</h1>
      <p>ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´ ë¸Œë¼ìš°ì €ì˜ <b>Speech Synthesis</b>ë¥¼ ì‚¬ìš©í•´ ì¤‘êµ­ì–´(í‘œì¤€ì–´)ë¡œ ì½ì–´ì¤ë‹ˆë‹¤. GitHub Pagesì—ì„œ ê·¸ëŒ€ë¡œ ë™ì‘í•˜ë©°, ì„œë²„ê°€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</p>
      <div class="grid">
        <div>
          <label for="text">ì¤‘êµ­ì–´ ê°„ì²´ ë¬¸ì¥ë“¤</label>
          <textarea id="text" placeholder="ì˜ˆ) å…¬å¸åŒäº‹ä¸­ï¼Œå‘¨å›´å»å¤–å›½ç•™å­¦çš„åŒäº‹å¤šå—ï¼Ÿ\næˆ‘ä¸Šä¸ªæ˜ŸæœŸå¼€å§‹åœ¨å…¬å›­è¿åŠ¨äº†ã€‚\nâ€¦â€¦"></textarea>
          <div class="row">
            <div>
              <label>ìŒì„±/ëª©ì†Œë¦¬</label><br/>
              <select id="voice"></select>
            </div>
            <div>
              <label>ì†ë„ <span id="rateVal" class="pill">1.0x</span></label><br/>
              <input type="range" id="rate" min="0.6" max="1.4" step="0.05" value="1.0" />
            </div>
            <div>
              <label>í”¼ì¹˜ <span id="pitchVal" class="pill">1.0</span></label><br/>
              <input type="range" id="pitch" min="0.8" max="1.2" step="0.05" value="1.0" />
            </div>
          </div>
          <div class="row" style="margin-top:16px">
            <button id="speak">ì›ì–´ë¯¼ì²˜ëŸ¼ ì½ê¸°</button>
            <button id="stop" class="sec">ì •ì§€</button>
            <button id="record" class="sec" title="í¬ë¡¬/ì—£ì§€: 'ì´ íƒ­ ê³µìœ  ë° ì˜¤ë””ì˜¤' í—ˆìš© í•„ìš”">ë…¹ìŒí•˜ì—¬ íŒŒì¼ë¡œ ì €ì¥ (ì‹¤í—˜ì )</button>
          </div>
          <div class="foot">â€» ì‰¼í‘œ(ï¼Œ)ëŠ” ì§§ì€ ì‰¬ëŠ” íƒ€ì´ë°ìœ¼ë¡œ, ë§ˆì¹¨í‘œ(ã€‚)ã€ë¬¼ìŒí‘œï¼ˆï¼Ÿï¼‰ã€ëŠë‚Œí‘œï¼ˆï¼ï¼‰ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ì¥ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.</div>
        </div>
        <div>
          <label>ëŒ€ê¸°ì—´(ë¬¸ì¥ë³„)</label>
          <div id="queue" class="list">ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´ ì—¬ê¸°ì— ë¶„ë¦¬ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <div class="muted" style="margin-top:6px">
            <div>â€¢ ì¤‘êµ­ì–´ ìŒì„±ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´: OS/ë¸Œë¼ìš°ì €ì— ì¤‘êµ­ì–´ ìŒì„±ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</div>
            <div>â€¢ íŒŒì¼ ì €ì¥: ë¸Œë¼ìš°ì €ê°€ íƒ­ ì˜¤ë””ì˜¤ ê³µìœ ë¥¼ ì§€ì›í•  ë•Œë§Œ ë™ì‘í•©ë‹ˆë‹¤(í¬ë¡¬/ì—£ì§€ ê¶Œì¥).</div>
          </div>
        </div>
      </div>
    </div>

    <p class="foot">åˆ¶ä½œè€…: ë‹¹ì‹  ğŸ™‚ | ì˜¤í”ˆì†ŒìŠ¤/ì„œë²„ë¦¬ìŠ¤ | GitHub Pagesì— <code>index.html</code>ë§Œ ì˜¬ë¦¬ë©´ ë!</p>
  </div>

  <script>
    // ---------- ìœ í‹¸: ë¬¸ì¥ ë¶„ë¦¬ ----------
    function splitSentences(text){
      // ì¤‘êµ­ì–´ ì¢…ê²°ë¶€í˜¸ì™€ ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
      const parts = text
        .replace(/([ã€‚ï¼ï¼Ÿ!?])/g, '$1\n') // ë¬¸ì¥ ëì— ì¤„ë°”ê¿ˆ
        .split(/\n+/)
        .map(s => s.replace(/\s+/g,'').trim()) // ê³µë°± ì œê±°
        .filter(Boolean);
      return parts;
    }

    // ---------- ìŒì„± ëª©ë¡ ë¡œë“œ ----------
    const voiceSel = document.getElementById('voice');
    let voices = [];
    function populateVoices(){
      voices = window.speechSynthesis.getVoices();
      const preferred = voices.filter(v => /zh|cmn|Chinese/i.test(v.lang || v.name));
      const list = preferred.length ? preferred : voices; // ì¤‘êµ­ì–´ ìš°ì„ , ì—†ìœ¼ë©´ ì „ì²´
      voiceSel.innerHTML = '';
      list.forEach((v, i) => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSel.appendChild(opt);
      });
    }
    populateVoices();
    window.speechSynthesis.onvoiceschanged = populateVoices;

    // ---------- ìƒíƒœ ----------
    let speaking = false;
    let stopRequested = false;

    const rateEl = document.getElementById('rate');
    const pitchEl = document.getElementById('pitch');
    const rateVal = document.getElementById('rateVal');
    const pitchVal = document.getElementById('pitchVal');
    rateEl.addEventListener('input', () => rateVal.textContent = `${Number(rateEl.value).toFixed(2)}x`);
    pitchEl.addEventListener('input', () => pitchVal.textContent = `${Number(pitchEl.value).toFixed(2)}`);

    const queueEl = document.getElementById('queue');
    const textEl = document.getElementById('text');

    function renderQueue(sentences){
      queueEl.innerHTML = sentences.map((s, idx) => `<div><span class="pill">${idx+1}</span> ${s}</div>`).join('') || 'ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´ ì—¬ê¸°ì— ë¶„ë¦¬ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.';
    }

    textEl.addEventListener('input', () => renderQueue(splitSentences(textEl.value)));

    // ---------- ë§í•˜ê¸° ----------
    async function speakAll(sentences){
      if(!sentences.length) return;
      speaking = true; stopRequested = false;
      for (const s of sentences){
        if(stopRequested){ break; }
        await speakOne(s);
      }
      speaking = false;
    }

    function speakOne(text){
      return new Promise(resolve => {
        const u = new SpeechSynthesisUtterance(text);
        const chosen = voices.find(v => v.name === voiceSel.value) || voices.find(v=>/zh|cmn|Chinese/i.test(v.lang||v.name)) || voices[0];
        if(chosen) u.voice = chosen;
        u.rate = Number(rateEl.value);
        u.pitch = Number(pitchEl.value);
        u.onend = resolve;
        u.onerror = resolve;
        speechSynthesis.speak(u);
      });
    }

    document.getElementById('speak').addEventListener('click', () => {
      const sentences = splitSentences(textEl.value);
      renderQueue(sentences);
      if(!sentences.length){ alert('ë¨¼ì € ì¤‘êµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if(speaking){ speechSynthesis.cancel(); speaking=false; }
      speakAll(sentences);
    });

    document.getElementById('stop').addEventListener('click', () => {
      stopRequested = true; speechSynthesis.cancel(); speaking=false;
    });

    // ---------- (ì‹¤í—˜ì ) íƒ­ ì˜¤ë””ì˜¤ ë…¹ìŒ â†’ íŒŒì¼ ì €ì¥ ----------
    // í¬ë¡¬/ì—£ì§€: getDisplayMediaì—ì„œ "ì´ íƒ­ ê³µìœ " + "ì˜¤ë””ì˜¤" ì„ íƒ í•„ìš”
    let mediaRecorder, chunks=[];
    async function startRecording(){
      // ì‚¬ìš©ìì—ê²Œ íƒ­ ê³µìœ  ìš”ì²­ (ì˜¤ë””ì˜¤ í¬í•¨)
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: true,
        audio: { echoCancellation: true, noiseSuppression: true }
      });
      // íƒ­ë§Œ ë…¹ìŒí•˜ë„ë¡ ë¹„ë””ì˜¤ íŠ¸ë™ì€ ì¦‰ì‹œ ì¤‘ì§€í•˜ê³ , ì˜¤ë””ì˜¤ë§Œ ì‚¬ìš©
      const audioTracks = stream.getAudioTracks();
      const audioStream = new MediaStream(audioTracks);
      mediaRecorder = new MediaRecorder(audioStream);
      chunks = [];
      mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `tts_zh_${Date.now()}.webm`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      };
      mediaRecorder.start();
      return stream; // í˜¸ì¶œ ì¸¡ì—ì„œ stopí•˜ë ¤ê³  ë°˜í™˜
    }

    async function recordAndSpeak(){
      const sentences = splitSentences(textEl.value);
      renderQueue(sentences);
      if(!sentences.length){ alert('ë¨¼ì € ì¤‘êµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      let displayStream;
      try{
        displayStream = await startRecording();
      }catch(e){
        alert('íƒ­ ì˜¤ë””ì˜¤ ê³µìœ ê°€ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í¬ë¡¬/ì—£ì§€ì—ì„œ "ì´ íƒ­ ê³µìœ "ì™€ "ì˜¤ë””ì˜¤"ë¥¼ ì¼œì£¼ì„¸ìš”.');
        return;
      }
      // ë…¹ìŒ ì‹œì‘ í›„ TTS ì¬ìƒ
      await speakAll(sentences);
      // ë‹¤ ì½ìœ¼ë©´ ë…¹ìŒ ì •ì§€
      if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      // í™”ë©´ ê³µìœ  ì¤‘ì§€
      displayStream.getTracks().forEach(t=>t.stop());
    }

    document.getElementById('record').addEventListener('click', recordAndSpeak);
  </script>
</body>
</html>
