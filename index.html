<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>중국어 TTS (재생 + MP3 저장)</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,"Noto Sans CJK KR",sans-serif; max-width: 800px; margin: 24px auto; padding: 0 16px; line-height: 1.5; }
    .row { margin: 12px 0; }
    label { display:inline-block; width:110px; font-weight:600; }
    textarea { width:100%; box-sizing: border-box; font-size:16px; }
    select, input[type="range"] { width: calc(100% - 120px); max-width: 420px; }
    button { padding:10px 14px; border:0; border-radius:10px; font-weight:600; cursor:pointer; }
    #goBtn { background:#2563eb; color:#fff; }
    #downloadLink { margin-left:10px; display:none; }
    .muted { color:#666; font-size:14px; }
    audio { width:100%; margin-top:10px; }
    .grid{ display:grid; grid-template-columns:110px 1fr; gap:8px 12px; align-items:center; }
  </style>
</head>
<body>
  <h2>중국어 TTS → 브라우저 재생 & MP3 다운로드</h2>

  <div class="row">
    <textarea id="text" rows="3">公司同事中, 周围去外国留学的同事多吗？</textarea>
  </div>

  <div class="grid">
    <label>목소리</label>
    <select id="voice">
      <!-- 중국 표준어(북경어) - 남/여 다양하게 -->
      <option value="cmn-CN-Wavenet-A">여성 · Wavenet A</option>
      <option value="cmn-CN-Wavenet-C">여성 · Wavenet C</option>
      <option value="cmn-CN-Wavenet-B">남성 · Wavenet B</option>
      <option value="cmn-CN-Wavenet-D">남성 · Wavenet D</option>
      <option value="cmn-CN-Standard-A">여성 · Standard A</option>
      <option value="cmn-CN-Standard-B">남성 · Standard B</option>
    </select>

    <label>속도</label>
    <div>
      <input type="range" id="speed" min="0.5" max="2.0" step="0.05" value="1.0" />
      <span id="speedVal" class="muted">1.00</span>
    </div>

    <label>피치</label>
    <div>
      <input type="range" id="pitch" min="-10" max="10" step="0.5" value="0" />
      <span id="pitchVal" class="muted">0.0</span>
    </div>
  </div>

  <div class="row">
    <button id="goBtn">생성 & 바로 듣기</button>
    <a id="downloadLink">MP3 다운로드</a>
  </div>

  <audio id="player" controls preload="none"></audio>

  <p class="muted">
    ※ Google Cloud Console &rarr; API 키에서 <b>HTTP referrer 허용 도메인</b>에 <code>https://dalmook.github.io/*</code>를 추가하세요.<br/>
    ※ 언어 코드는 <code>cmn-CN</code>(중국 표준어) 사용.
  </p>

  <script>
    const textEl = document.getElementById('text');
    const voiceEl = document.getElementById('voice');
    const speedEl = document.getElementById('speed');
    const pitchEl = document.getElementById('pitch');
    const speedVal = document.getElementById('speedVal');
    const pitchVal = document.getElementById('pitchVal');
    const goBtn = document.getElementById('goBtn');
    const player = document.getElementById('player');
    const downloadLink = document.getElementById('downloadLink');

    speedEl.oninput = () => speedVal.textContent = Number(speedEl.value).toFixed(2);
    pitchEl.oninput = () => pitchVal.textContent = Number(pitchEl.value).toFixed(1);

    async function synthesizeAndPlay() {
      const apiKey = "AIzaSyB75eePCH1FTX3jXLA2mfk0EwoV_uf-Yxg"; // ← 여기에 자신의 Google Cloud API 키 넣기
      const text = textEl.value.trim();
      if (!text) return alert("텍스트를 입력하세요.");

      goBtn.disabled = true; goBtn.textContent = "생성 중...";
      downloadLink.style.display = "none";
      player.removeAttribute('src');

      try {
        const res = await fetch(
          `https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input: { text },
              voice: {
                languageCode: "cmn-CN",
                name: voiceEl.value
              },
              audioConfig: {
                audioEncoding: "MP3",
                speakingRate: Number(speedEl.value), // 0.25 ~ 4.0
                pitch: Number(pitchEl.value)         // -20.0 ~ 20.0
              }
            })
          }
        );

        const data = await res.json();
        if (!data.audioContent) {
          throw new Error(JSON.stringify(data));
        }

        // Base64 → Blob → blob URL
        const byteString = atob(data.audioContent);
        const byteArray = new Uint8Array(byteString.length);
        for (let i = 0; i < byteString.length; i++) byteArray[i] = byteString.charCodeAt(i);
        const blob = new Blob([byteArray], { type: "audio/mpeg" });
        const url = URL.createObjectURL(blob);

        // 오디오 플레이어로 즉시 재생
        player.src = url;
        player.play().catch(() => {/* 사용자가 상호작용 후 재생 필요할 수 있음 */});

        // 다운로드 링크 노출
        downloadLink.href = url;
        downloadLink.download = "tts.mp3";
        downloadLink.style.display = "inline-block";
        downloadLink.textContent = "MP3 다운로드";
      } catch (e) {
        alert("TTS 생성 실패: " + e.message);
      } finally {
        goBtn.disabled = false; goBtn.textContent = "생성 & 바로 듣기";
      }
    }

    document.getElementById('goBtn').addEventListener('click', synthesizeAndPlay);
  </script>
</body>
</html>
